<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1A2E06" />
  <meta name="description" content="Tu vida vikinga completa: necesidades, tareas y gloria" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" sizes="512x512" type="image/png" />
  <link rel="apple-touch-icon" href="icon.png" />
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1A2E06;
      --celtic: #3D9970;
      --frankish: #8B0000;
      --northern: #8B4513;
      --gold: #FFD700;
      --dark: #0F1A0F;
      --light: #F0F8E6;
      --ui-border: #5D4037;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'MedievalSharp', cursive;
      background: url('https://placehold.co/1920x1080/0F1A0F/1A2E06?text=') center/cover fixed;
      color: var(--light);
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.8);
      border: 4px solid var(--gold);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    }
    header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--gold);
      padding-bottom: 15px;
    }
    h1 {
      font-size: 2.8em;
      color: var(--gold);
      text-shadow: 3px 3px 6px #000;
    }
    .subtitle {
      font-size: 1.2em;
      color: #AAA;
    }

    .profile {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: rgba(26, 46, 6, 0.5);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid var(--ui-border);
    }
    .profile-item {
      flex: 1;
      min-width: 150px;
    }
    .xp-bar {
      width: 100%;
      height: 18px;
      background: #000;
      border: 1px solid var(--gold);
      border-radius: 10px;
      overflow: hidden;
      margin: 5px 0;
    }
    .xp-fill {
      height: 100%;
      width: 0%;
      background: var(--gold);
      transition: width 0.5s ease;
    }

    .needs {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .need-item {
      flex: 1;
      min-width: 150px;
      background: rgba(26, 46, 6, 0.5);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #5D4037;
    }
    .need-bar {
      width: 100%;
      height: 15px;
      background: #000;
      border: 1px solid var(--gold);
      border-radius: 8px;
      overflow: hidden;
      margin: 5px 0;
    }
    .need-fill {
      height: 100%;
      width: 100%;
      background: var(--gold);
      transition: width 0.2s linear;
    }
    .need-warning {
      font-size: 0.9em;
      color: #FF6B6B;
      display: none;
    }
    .need-btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--gold);
      color: var(--dark);
      border: none;
      border-radius: 6px;
      font-family: 'MedievalSharp', cursive;
      font-size: 0.9em;
      cursor: pointer;
      width: 100%;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 5px;
    }
    .tab {
      padding: 12px 20px;
      background: var(--ui-border);
      color: #DDD;
      border: none;
      cursor: pointer;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.1em;
      border-radius: 8px 8px 0 0;
    }
    .tab.active {
      background: var(--gold);
      color: var(--dark);
      font-weight: bold;
    }

    .task-list {
      list-style: none;
    }
    .task-item {
      background: rgba(255, 255, 255, 0.05);
      margin: 12px 0;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      border: 1px solid #333;
    }
    .task-item.completed {
      background: rgba(60, 100, 60, 0.3);
      border-color: #2E7D32;
      opacity: 0.7;
    }
    .task-checkbox {
      margin-right: 15px;
      width: 22px;
      height: 22px;
      cursor: pointer;
    }
    .task-content {
      flex: 1;
    }
    .task-type {
      font-size: 0.8em;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .task-points {
      color: var(--gold);
      font-weight: bold;
    }

    .achievement-item {
      display: flex;
      margin: 15px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 2px dashed #555;
      align-items: center;
    }
    .achievement-icon {
      width: 60px;
      height: 60px;
      background: #222;
      border: 2px solid var(--gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.4em;
    }
    .achievement-locked {
      opacity: 0.5;
    }
    .achievement-info h4 {
      color: var(--gold);
      margin: 0 0 4px 0;
    }
    .achievement-info p {
      font-size: 0.9em;
      margin: 0;
    }

    .btn-reset {
      display: block;
      margin: 25px auto;
      padding: 12px 25px;
      background: var(--dark);
      color: var(--gold);
      border: 2px solid var(--gold);
      border-radius: 8px;
      cursor: pointer;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.1em;
    }

    .alert {
      background: #8B0000;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 0.9em;
      color: #777;
    }

    .tab-content {
      display: none;
      padding: 20px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      border: 1px solid var(--ui-border);
    }
    .tab-content.active {
      display: block;
    }

    .diario-entrada {
      background: rgba(0,0,0,0.4);
      border: 1px solid #5D4037;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .diario-fecha {
      font-size: 0.8em;
      color: var(--gold);
      margin-bottom: 10px;
    }
    .diario-contenido {
      margin: 10px 0;
    }
    .diario-imagen {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid var(--gold);
    }
    .diario-borrar {
      background: #8B0000;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>

  <!-- Firebase SDK (sin import, solo compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚öîÔ∏è Cr√≥nica de la Glor√≠a Eterna</h1>
      <p class="subtitle">Tu vida vikinga en armon√≠a con el tiempo</p>
    </header>

    <!-- Perfil Vikingo -->
    <div class="profile">
      <div class="profile-item">
        <strong>Eivor, el Legendario</strong><br>
        <span>Rango: <span id="rank">Jefe de Asentamiento</span></span><br>
        <span>Nivel: <span id="level">1</span></span>
      </div>
      <div class="profile-item">
        <small>Glory Total: <span id="points">0</span></small><br>
        <div class="xp-bar">
          <div class="xp-fill" id="xp-fill"></div>
        </div>
        <small>Progreso de Gloria</small>
      </div>
    </div>

    <!-- Necesidades -->
    <div class="needs">
      <div class="need-item">
        <strong>üçΩÔ∏è Alimentaci√≥n</strong>
        <div class="need-bar">
          <div class="need-fill" id="food-fill"></div>
        </div>
        <small>Hambre crece con el tiempo</small>
        <div class="need-warning" id="food-alert">¬°Es hora de almorzar!</div>
        <button class="need-btn" onclick="satisfacer('food')">‚úÖ Com√≠</button>
      </div>
      <div class="need-item">
        <strong>üõèÔ∏è Descanso</strong>
        <div class="need-bar">
          <div class="need-fill" id="sleep-fill"></div>
        </div>
        <small>La noche exige reposo</small>
        <div class="need-warning" id="sleep-alert">¬°Ve a dormir!</div>
        <button class="need-btn" onclick="satisfacer('sleep')">‚úÖ Dorm√≠</button>
      </div>
      <div class="need-item">
        <strong>üë• Comunidad</strong>
        <div class="need-bar">
          <div class="need-fill" id="social-fill"></div>
        </div>
        <small>D√≠as sin socializar</small>
        <div class="need-warning" id="social-alert">¬°Visita a tus amigos!</div>
        <button class="need-btn" onclick="satisfacer('social')">‚úÖ Socialic√©</button>
      </div>
    </div>

    <!-- Pesta√±as -->
    <div class="tabs">
      <button class="tab active" id="tab-diaria">üåû Diaria</button>
      <button class="tab" id="tab-continua">üîÅ Continua</button>
      <button class="tab" id="tab-semanal">üìÖ Semanal</button>
      <button class="tab" id="tab-logros">üèÜ Logros</button>
      <button class="tab" id="tab-diario">üìñ Diario</button>
    </div>

    <!-- Secci√≥n Diaria -->
    <div class="tab-content active" id="content-diaria">
      <h3>üåÖ Tareas Diarias</h3>
      <div id="daily-timer" class="alert" style="background:var(--northern)">
        Pr√≥ximas tareas en: <strong id="time-left">--:--:--</strong>
      </div>
      <ul class="task-list" id="tasks-diaria"></ul>
    </div>

    <!-- Secci√≥n Continua -->
    <div class="tab-content" id="content-continua">
      <h3>üéØ Tareas Continuas</h3>
      <p>Completa conjuntos para desbloquear nuevos desaf√≠os.</p>
      <ul class="task-list" id="tasks-continua"></ul>
    </div>

    <!-- Secci√≥n Semanal -->
    <div class="tab-content" id="content-semanal">
      <h3>üèÜ Desaf√≠os Semanales</h3>
      <ul class="task-list" id="tasks-semanal"></ul>
    </div>

    <!-- Secci√≥n de Logros -->
    <div class="tab-content" id="content-logros">
      <h3>üèÜ Logros Vikingos</h3>
      <div id="achievements-list"></div>
    </div>

    <!-- Secci√≥n Diario -->
    <div class="tab-content" id="content-diario">
      <h3>üìñ Tu Cr√≥nica Vikinga</h3>
      <p>Escribe tus haza√±as y a√±ade im√°genes del modo foto del juego.</p>
      <div style="background: rgba(26,46,6,0.5); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <textarea id="diario-texto" placeholder="Hoy, bajo un cielo tormentoso, desembarcamos en las costas de Par√≠s..." 
                  rows="4" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gold); 
                  background: #000; color: var(--light); font-family: 'MedievalSharp', cursive;"></textarea>
        <div style="margin: 10px 0;">
          <label for="diario-imagen" style="display: block; margin-bottom: 5px; color: var(--gold);">üñºÔ∏è A√±adir imagen (modo foto):</label>
          <input type="file" id="diario-imagen" accept="image/*" style="color: white;">
        </div>
        <button class="btn-reset" id="diario-guardar" style="width: 100%;">‚ûï A√±adir Entrada</button>
      </div>
      <div id="diario-entradas"></div>
    </div>

    <!-- Botones de importar/exportar -->
    <div style="text-align: center; margin: 15px 0; display: flex; gap: 10px; justify-content: center;">
      <button class="btn-reset" id="export-btn">üíæ Exportar Progreso</button>
      <button class="btn-reset" id="import-btn">üì§ Importar Progreso</button>
    </div>

    <button class="btn-reset" id="reset-btn">üîÅ Reiniciar Todo</button>

    <footer>"La gloria no es un destino, es una vida bien vivida." ‚Äî Eivor</footer>
  </div>

  <script>
    // === CONFIGURACI√ìN DE FIREBASE (sin import, solo compat) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBT3PbVakp9QRCKfXFq37T_dW8YwCOzuRc",
      authDomain: "valhalla-chronicle.firebaseapp.com",
      databaseURL: "https://valhalla-chronicle-default-rtdb.firebaseio.com",
      projectId: "valhalla-chronicle",
      storageBucket: "valhalla-chronicle.firebasestorage.app",
      messagingSenderId: "561114275300",
      appId: "1:561114275300:web:c62031e772729a5048fbf1"
    };

    // Inicializar Firebase (sin import)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const progressRef = db.ref('valhalla-chronicle/progress');

    // === CONTROL DE VERSI√ìN (anti-cach√©) ===
    const CURRENT_VERSION = 'v1.9';
    const storedVersion = localStorage.getItem('appVersion');
    if (storedVersion !== CURRENT_VERSION) {
      if ('caches' in window) {
        caches.keys().then(names => names.forEach(name => caches.delete(name)));
      }
      localStorage.setItem('appVersion', CURRENT_VERSION);
      location.reload();
    }

    // === TAREAS CONTINUAS ===
    const TASKS_CONTINUA_POOL = [
  // üé£ PESCA
  { text: "Pesca 5 peces en el r√≠o Shannon (Irlanda)", type: "Pesca", points: 30 },
  { text: "Pesca un salm√≥n legendario en Noruega", type: "Pesca", points: 40 },
  { text: "Pesca de noche en el lago de Lunden", type: "Pesca", points: 35 },
  { text: "Pesca en el lago de Gl√¶sting scire", type: "Pesca", points: 30 },
  { text: "Pesca cerca del monasterio de Ravensthorpe", type: "Pesca", points: 30 },

  // ü¶å CAZA
  { text: "Caza un ciervo legendario en Mercia", type: "Caza", points: 40 },
  { text: "Caza un oso en las monta√±as de Sudrec", type: "Caza", points: 50 },
  { text: "Caza 10 lobos salvajes", type: "Caza", points: 60 },
  { text: "Caza un lobo negro en East Anglia", type: "Caza", points: 50 },
  { text: "Caza un jabal√≠ en Defnas", type: "Caza", points: 40 },
  { text: "Caza un √°guila en Connacht", type: "Caza", points: 45 },

  // üé≤ MINIJUEGOS
  { text: "Gana una partida de Orlog", type: "Juego", points: 30 },
  { text: "Gana una partida de Juego de Bebida (Mead Challenge)", type: "Juego", points: 30 },
  { text: "Gana 3 partidas de Orlog seguidas", type: "Juego", points: 50 },
  { text: "Gana un duelo de bardos en una taberna", type: "Arte", points: 35 },
  { text: "Juega Orlog con Randvi en Ravensthorpe", type: "Juego", points: 30 },

  // üí∞ FARMEO
  { text: "Roba 5 cofres escondidos en cuevas", type: "Farmeo", points: 40 },
  { text: "Farmea 1000 monedas de plata", type: "Farmeo", points: 50 },
  { text: "Vende 20 pieles en un mercado", type: "Farmeo", points: 35 },
  { text: "Roba un cofre en una fortaleza sin ser visto", type: "Sigilo", points: 50 },
  { text: "Farmea hierro en minas de Ledecestrescire", type: "Farmeo", points: 40 },
  { text: "Roba un cofre del templo celta en Meonia", type: "Farmeo", points: 45 },

  // ‚öîÔ∏è COMBATE
  { text: "Mata a 20 enemigos con armas pesadas", type: "Combate", points: 40 },
  { text: "Mata a 10 guardias sin ser detectado", type: "Sigilo", points: 50 },
  { text: "Mata a un jefe de fortaleza con arco", type: "Combate", points: 60 },
  { text: "Mata a 5 enemigos con lanzamiento de hacha", type: "Combate", points: 45 },
  { text: "Completa un asalto sin morir", type: "Liderazgo", points: 75 },
  { text: "Mata a un druida oscuro en Connacht", type: "Combate", points: 50 },
  { text: "Mata a un comandante franco en Par√≠s", type: "Combate", points: 70 },

  // üåç EXPLORACI√ìN
  { text: "Visita el C√≠rculo de Piedras de Tara (Irlanda)", type: "Exploraci√≥n", points: 40 },
  { text: "Visita la Catedral de Notre-Dame (Par√≠s)", type: "Exploraci√≥n", points: 45 },
  { text: "Toma una foto √©pica en el Acantilado de Ravensthorpe", type: "Exploraci√≥n", points: 30 },
  { text: "Explora la cueva de los druidas en Connacht", type: "Exploraci√≥n", points: 50 },
  { text: "Visita el templo de Odin en Noruega", type: "Exploraci√≥n", points: 40 },
  { text: "Explora el bosque encantado de Sciropescire", type: "Exploraci√≥n", points: 45 },
  { text: "Visita la tumba de los antepasados en Oxenefordscire", type: "Exploraci√≥n", points: 40 },
  { text: "Explora la fortaleza abandonada de Lunden", type: "Exploraci√≥n", points: 35 },
  { text: "Visita el monasterio de Gl√¶sting scire", type: "Exploraci√≥n", points: 30 },
  { text: "Explora la mina de hierro en Cent", type: "Exploraci√≥n", points: 30 },
  { text: "Visita el puente colgante de Suthsexe", type: "Exploraci√≥n", points: 35 },
  { text: "Explora el campo de batalla de Elmet", type: "Exploraci√≥n", points: 40 },
  { text: "Visita el lago de East Anglia", type: "Exploraci√≥n", points: 30 },
  { text: "Explora el fuerte romano en Defnas", type: "Exploraci√≥n", points: 45 },
  { text: "Visita el asentamiento vikingo en Jorvik", type: "Exploraci√≥n", points: 35 },
  { text: "Explora el templo celta en Meonia", type: "Exploraci√≥n", points: 50 },
  { text: "Visita el cr√°ter del meteorito en Sciropescire", type: "Exploraci√≥n", points: 40 },
  { text: "Explora el cementerio de barcos en Noruega", type: "Exploraci√≥n", points: 50 },
  { text: "Visita el altar dru√≠dico en Connacht", type: "Exploraci√≥n", points: 45 },
  { text: "Explora el bosque de Wicklow (Irlanda)", type: "Exploraci√≥n", points: 40 },

  // üõ†Ô∏è PROGRESO
  { text: "Conseguir un punto de habilidad en el √°rbol de Od√≠n", type: "Progreso", points: 40 },
  { text: "Desbloquea una nueva habilidad de sigilo", type: "Progreso", points: 45 },
  { text: "Mejora tu casa en Ravensthorpe", type: "Construcci√≥n", points: 35 },
  { text: "Desbloquea una habilidad de combate pesado", type: "Progreso", points: 45 },
  { text: "Mejora tu barco con nuevas decoraciones", type: "Construcci√≥n", points: 40 },

  // üåø DLC: IRLANDA
  { text: "Completa una misi√≥n de rebelde irland√©s", type: "DLC Irlanda", points: 50 },
  { text: "Mata a un druida oscuro en Connacht", type: "DLC Irlanda", points: 45 },
  { text: "Completa una exigencia real del rey irland√©s", type: "DLC Irlanda", points: 60 },
  { text: "Roba un tesoro del monasterio de Durrow", type: "DLC Irlanda", points: 50 },
  { text: "Gana una partida de Orlog en un campamento rebelde", type: "DLC Irlanda", points: 35 },

  // üè∞ DLC: PAR√çS
  { text: "Completa una misi√≥n de asedio en Par√≠s", type: "DLC Par√≠s", points: 60 },
  { text: "Sobrevive una noche en el campamento franco", type: "DLC Par√≠s", points: 50 },
  { text: "Roba un documento secreto del palacio", type: "DLC Par√≠s", points: 55 },
  { text: "Mata a un comandante franco en combate", type: "DLC Par√≠s", points: 70 },
  { text: "Escapa de una trampa en el subsuelo de Par√≠s", type: "DLC Par√≠s", points: 50 },

  // üê∫ MONTURAS
  { text: "Domestica un caballo blanco en East Anglia", type: "Montura", points: 40 },
  { text: "Encuentra y monta el lobo negro", type: "Montura", points: 50 },
  { text: "Domestica un oso en Noruega", type: "Montura", points: 60 }
];

    // === LOGROS ===
    const achievementsList = [
      { id: 'ach-daily', title: 'Guardi√°n del D√≠a', desc: 'Completa 7 d√≠as seguidos de tareas diarias', icon: 'üåû', condition: () => tasks.diaria.filter(t => t.completed).length >= 7 },
      { id: 'ach-beast', title: 'Hermano de Fenrir', desc: 'Completa 15 tareas de caza o naturaleza', icon: 'üê∫', condition: () => tasks.continua.filter(t => t.completed && (t.type === 'Caza' || t.text.includes('caza') || t.text.includes('lobo'))).length >= 15 },
      { id: 'ach-orlog', title: 'Maestro del Orlog', desc: 'Gana 5 partidas de Orlog', icon: 'üé≤', condition: () => tasks.continua.filter(t => t.completed && (t.text.includes('Orlog') || t.text.includes('juega'))).length >= 5 },
      { id: 'ach-explorer', title: 'Explorador del Mundo', desc: 'Completa 20 tareas de exploraci√≥n', icon: 'üåç', condition: () => tasks.continua.filter(t => t.completed && t.type === 'Exploraci√≥n').length >= 20 },
      { id: 'ach-silent', title: 'Fantasma de Midgard', desc: 'Completa 10 tareas de sigilo', icon: 'üë§', condition: () => tasks.continua.filter(t => t.completed && (t.type === 'Sigilo' || t.text.includes('sin ser visto'))).length >= 10 },
      { id: 'ach-raider', title: 'Saqueador de R√≠os', desc: 'Realiza 5 saqueos fluviales', icon: '‚öîÔ∏è', condition: () => tasks.diaria.filter(t => t.completed && t.text.includes('saqueo fluvial')).length >= 5 },
      { id: 'ach-irlanda', title: 'Rey de √âriu', desc: 'Completa 10 misiones del DLC de Irlanda', icon: '‚òòÔ∏è', condition: () => tasks.continua.filter(t => t.completed && t.type === 'DLC Irlanda').length >= 10 },
      { id: 'ach-paris', title: 'Asediador de Lutetia', desc: 'Completa 8 misiones del DLC de Par√≠s', icon: 'üóº', condition: () => tasks.continua.filter(t => t.completed && t.type === 'DLC Par√≠s').length >= 8 },
      { id: 'ach-level', title: 'El Inmortal', desc: 'Alcanza el nivel 10', icon: '‚ö°', condition: () => player.level >= 10 },
      { id: 'ach-farmeo', title: 'Tesorero Vikingo', desc: 'Farmea 5000 monedas de plata', icon: 'üí∞', condition: () => player.points >= 5000 },
      { id: 'ach-continua', title: 'Dominio Eterno', desc: 'Completa 3 conjuntos de tareas continuas', icon: 'üî•', condition: () => player.continuaSetsCompleted >= 3 }
    ];
    let unlockedAchievements = {};

    // === ESTADO DEL JUGADOR ===
    let player = {
      points: 0, level: 1, xp: 0,
      food: 100, sleep: 100, social: 100,
      lastReset: Date.now(),
      lastFood: Date.now(), lastSleep: Date.now(), lastSocial: Date.now(),
      continuaSetsCompleted: 0, weeklyCompleted: 0
    };
    let tasks = { diaria: [], continua: [], semanal: [] };
    let entradasDiario = [];

    // === FUNCIONES ===
    function getRank() {
      const ranks = ["Jefe de Asentamiento", "Guerrero de Midgard", "Terror de Mercia", "Rey de Irlanda", "Semidi√≥s N√≥rdico", "El Inmortal"];
      return ranks[player.level - 1] || ranks[ranks.length - 1];
    }
    function getRequiredXP(level) { return level * 100; }
    function updateLevel() {
      const maxXp = getRequiredXP(player.level);
      if (player.xp >= maxXp) {
        player.xp -= maxXp; player.level++;
        alert(`¬°Ascendiste al nivel ${player.level}! Eres ahora: ${getRank()}`);
        updateUI();
      }
    }

    function generateContextualTask() {
      const h = new Date().getHours();
      if (h >= 7 && h < 10) return { text: "üåÖ Desayuna con tu clan", type: "Hora", points: 30, id: 'ctx-morning' };
      if (h >= 12 && h < 14) return { text: "üçΩÔ∏è Almuerza en Lunden", type: "Hora", points: 35, id: 'ctx-noon' };
      if (h >= 20 && h < 23) return { text: "üõèÔ∏è Ve a dormir", type: "Hora", points: 40, id: 'ctx-sleep' };
      return { text: "üåç Explora una regi√≥n", type: "Hora", points: 25, id: 'ctx-explore' };
    }
    function generateFixedDailyTasks() {
      return [
        { text: "üë• Habla con Randvi", type: "Diaria", points: 25, id: 'daily-social' },
        { text: "‚öîÔ∏è Realiza un saqueo fluvial", type: "Diaria", points: 50, id: 'daily-raider' },
        { text: "üé≤ Juega una partida de Orlog", type: "Diaria", points: 30, id: 'daily-orlog' }
      ];
    }
    function generateDailyTasks() {
      return [generateContextualTask(), ...generateFixedDailyTasks()];
    }

    function updateContextualTask() {
      const index = tasks.diaria.findIndex(t => t.id && t.id.startsWith('ctx-'));
      if (index !== -1) {
        const newTask = generateContextualTask();
        if (tasks.diaria[index].id !== newTask.id) {
          tasks.diaria[index] = newTask;
          if (document.getElementById('tab-diaria').classList.contains('active')) {
            renderTasks('diaria');
          }
        }
      }
    }

    function startDailyTimer() {
      const resetInterval = 24 * 60 * 60 * 1000;
      function updateTimer() {
        const now = Date.now();
        const nextReset = player.lastReset + resetInterval;
        const timeLeft = nextReset - now;

        if (timeLeft > 0) {
          const h = Math.floor(timeLeft / 3600000);
          const m = Math.floor((timeLeft % 3600000) / 60000);
          const s = Math.floor((timeLeft % 60000) / 1000);
          document.getElementById('time-left').textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        } else {
          document.getElementById('time-left').textContent = "Renovadas";
          tasks.diaria = generateDailyTasks();
          player.lastReset = now;
          saveProgress();
          if (document.getElementById('tab-diaria').classList.contains('active')) {
            renderTasks('diaria');
          }
        }
      }
      updateTimer();
      setInterval(updateTimer, 1000);
    }

    function loadProgress() {
  progressRef.once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (data) {
        localStorage.setItem('valhallaChronicle', JSON.stringify(data));
        player = { ...player, ...data.player };
        tasks = data.tasks || { diaria: [], continua: [], semanal: [] };

        // ‚úÖ Reconstruir tareas semanales con condiciones
        const weeklyTemplate = generateWeeklyTasks(); // Plantilla con condiciones
        if (tasks.semanal && Array.isArray(tasks.semanal)) {
          // Mantener estado de completado
          weeklyTemplate.forEach(tareaNueva => {
            const tareaGuardada = tasks.semanal.find(t => t.id === tareaNueva.id);
            if (tareaGuardada && tareaGuardada.completed) {
              tareaNueva.completed = true;
            }
          });
        }
        tasks.semanal = weeklyTemplate;

        unlockedAchievements = data.unlockedAchievements || {};
        entradasDiario = data.diario || [];
      } else {
        // Si no hay datos en Firebase, usa localStorage
        const saved = localStorage.getItem('valhallaChronicle');
        if (saved) {
          const localData = JSON.parse(saved);
          player = { ...player, ...localData.player };
          tasks = localData.tasks || { diaria: [], continua: [], semanal: [] };

          // ‚úÖ Reconstruir tareas semanales desde localStorage
          const weeklyTemplate = generateWeeklyTasks();
          if (tasks.semanal && Array.isArray(tasks.semanal)) {
            weeklyTemplate.forEach(tareaNueva => {
              const tareaGuardada = tasks.semanal.find(t => t.id === tareaNueva.id);
              if (tareaGuardada && tareaGuardada.completed) {
                tareaNueva.completed = true;
              }
            });
          }
          tasks.semanal = weeklyTemplate;

          unlockedAchievements = localData.unlockedAchievements || {};
          entradasDiario = localData.diario || [];
        }
      }

      // Asegurar que lastReset exista
      if (!player.lastReset) player.lastReset = Date.now();

      // Inicializar UI
      updateUI();
      renderAll();
      checkWeeklyTasks(); // Verificar al cargar
      setInterval(checkWeeklyTasks, 60000); // Cada minuto
      renderizarDiario();
      startDailyTimer();
    })
    .catch(err => {
      console.error('‚ùå No se pudo conectar a Firebase. Usando localStorage.', err);
      const saved = localStorage.getItem('valhallaChronicle');
      if (saved) {
        const data = JSON.parse(saved);
        player = { ...player, ...data.player };
        tasks = data.tasks || { diaria: [], continua: [], semanal: [] };

        // ‚úÖ Reconstruir tareas semanales en modo offline
        const weeklyTemplate = generateWeeklyTasks();
        if (tasks.semanal && Array.isArray(tasks.semanal)) {
          weeklyTemplate.forEach(tareaNueva => {
            const tareaGuardada = tasks.semanal.find(t => t.id === tareaNueva.id);
            if (tareaGuardada && tareaGuardada.completed) {
              tareaNueva.completed = true;
            }
          });
        }
        tasks.semanal = weeklyTemplate;

        unlockedAchievements = data.unlockedAchievements || {};
        entradasDiario = data.diario || [];
      }

      if (!player.lastReset) player.lastReset = Date.now();

      updateUI();
      renderAll();
      checkWeeklyTasks();
      setInterval(checkWeeklyTasks, 60000);
      renderizarDiario();
      startDailyTimer();
    });
}
    function saveProgress() {
      const data = { player, tasks, unlockedAchievements, diario: entradasDiario };
      localStorage.setItem('valhallaChronicle', JSON.stringify(data));
      progressRef.set(data)
        .then(() => console.log('‚úÖ Progreso guardado en la nube'))
        .catch(err => console.error('‚ùå Error al guardar en Firebase:', err));
    }

    function updateUI() {
      const hoursF = (Date.now() - player.lastFood) / 3600000;
      const hoursS = (Date.now() - player.lastSleep) / 3600000;
      const daysSoc = (Date.now() - player.lastSocial) / 86400000;

      player.food = Math.max(0, 100 - hoursF * 15);
      player.sleep = Math.max(0, 100 - hoursS * 12);
      player.social = Math.max(0, 100 - daysSoc * 30);

      document.getElementById('food-fill').style.width = player.food + '%';
      document.getElementById('sleep-fill').style.width = player.sleep + '%';
      document.getElementById('social-fill').style.width = player.social + '%';

      document.getElementById('food-alert').style.display = player.food < 30 ? 'block' : 'none';
      document.getElementById('sleep-alert').style.display = player.sleep < 30 ? 'block' : 'none';
      document.getElementById('social-alert').style.display = player.social < 30 ? 'block' : 'none';

      document.getElementById('points').textContent = player.points;
      document.getElementById('level').textContent = player.level;
      document.getElementById('rank').textContent = getRank();

      const maxXp = getRequiredXP(player.level);
      const xpPercent = (player.xp / maxXp) * 100;
      document.getElementById('xp-fill').style.width = `${xpPercent}%`;
    }

    function satisfacer(necesidad) {
      if (necesidad === 'food') player.food = 100;
      if (necesidad === 'sleep') player.sleep = 100;
      if (necesidad === 'social') player.social = 100;
      saveProgress();
      updateUI();
      alert(`‚úÖ Has satisfecho tu necesidad de ${necesidad}.`);
    }

    function renderAchievements() {
      const container = document.getElementById('achievements-list');
      container.innerHTML = '';
      achievementsList.forEach(ach => {
        if (ach.condition() && !unlockedAchievements[ach.id]) {
          unlockedAchievements[ach.id] = true;
          alert(`üèÜ ¬°Logro desbloqueado! ${ach.title}`);
          saveProgress();
        }
        const item = document.createElement('div');
        item.className = `achievement-item ${unlockedAchievements[ach.id] ? '' : 'achievement-locked'}`;
        item.innerHTML = `<div class="achievement-icon">${unlockedAchievements[ach.id] ? ach.icon : '?'}</div>
                          <div class="achievement-info"><h4>${ach.title}</h4><p>${ach.desc}</p></div>`;
        container.appendChild(item);
      });
    }

    function generateContinuaTasks() {
      const pool = [...TASKS_CONTINUA_POOL];
      const selected = [];
      for (let i = 0; i < 10 && pool.length > 0; i++) {
        const rand = Math.floor(Math.random() * pool.length);
        selected.push({ ...pool[rand], id: 'c' + i, completed: false });
        pool.splice(rand, 1);
      }
      return selected;
    }

    function generateWeeklyTasks() {
  return [
    {
      id: 'w1',
      text: "üèπ Maestro del Arco: completa 10 tareas de combate a distancia",
      type: "Semanal",
      points: 100,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Combate' || t.text.includes('arco') || t.text.includes('distancia'))
        ).length >= 10;
      }
    },
    {
      id: 'w2',
      text: "üê∫ Hermano de la Naturaleza: completa 8 tareas de caza o exploraci√≥n",
      type: "Semanal",
      points: 90,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Caza' || t.type === 'Exploraci√≥n')
        ).length >= 8;
      }
    },
    {
      id: 'w3',
      text: "‚öîÔ∏è Terror de Mercia: completa 12 tareas de combate pesado",
      type: "Semanal",
      points: 110,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Combate' || t.text.includes('pesado') || t.text.includes('asalto'))
        ).length >= 12;
      }
    },
    {
      id: 'w4',
      text: "üé£ Pescador del Norte: completa 6 tareas de pesca",
      type: "Semanal",
      points: 80,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && t.type === 'Pesca'
        ).length >= 6;
      }
    },
    {
      id: 'w5',
      text: "üß† Estratega Vikingo: completa 5 tareas de sigilo o inteligencia",
      type: "Semanal",
      points: 95,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Sigilo' || t.text.includes('sin ser visto') || t.text.includes('esp√≠a'))
        ).length >= 5;
      }
    },
    {
      id: 'w6',
      text: "üè∞ Constructor de Ravensthorpe: mejora 3 edificios",
      type: "Semanal",
      points: 100,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Construcci√≥n' || t.text.includes('mejora') || t.text.includes('construye'))
        ).length >= 3;
      }
    },
    {
      id: 'w7',
      text: "üõ°Ô∏è Campe√≥n de los Clanes: completa 15 tareas de liderazgo",
      type: "Semanal",
      points: 120,
      completed: false,
      condition: () => {
        return tasks.continua.filter(t => 
          t.completed && 
          (t.type === 'Liderazgo' || t.text.includes('asalto') || t.text.includes('lidera'))
        ).length >= 15;
      }
    },
    {
      id: 'w8',
      text: "üìú Cronista de la Gloria: escribe 4 entradas en el diario",
      type: "Semanal",
      points: 85,
      completed: false,
      condition: () => {
        return entradasDiario.length >= 4;
      }
    }
  ];
}

    function renderTasks(zone) {
      const list = document.getElementById(`tasks-${zone}`);
      list.innerHTML = '';
      (tasks[zone] || []).forEach(task => {
        if (!task.id) task.id = zone + Math.random();
        const li = document.createElement('li');
        li.className = `task-item ${task.completed ? 'completed' : ''}`;
        li.innerHTML = `<input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-content"><div class="task-type">${task.type}</div>${task.text}</div>
                        <span class="task-points">+${task.points}</span>`;
        li.querySelector('.task-checkbox').addEventListener('change', () => {
          if (li.querySelector('.task-checkbox').checked && !task.completed) {
            task.completed = true;
            player.points += task.points;
            player.xp += task.points;
            updateLevel();
            if (zone === 'continua' && tasks.continua.filter(t => t.completed).length >= 5) {
              alert("üéâ ¬°Conjunto completado!");
              tasks.continua = generateContinuaTasks();
              renderTasks('continua');
            }
            saveProgress();
          }
          updateUI();
        });
        list.appendChild(li);
      });
    }

    function renderAll() {
      renderTasks('diaria');
      renderTasks('continua');
      renderTasks('semanal');
    }

    // === DIARIO ===
    function cargarDiario() {
      const guardadas = localStorage.getItem('valhalla_diario');
      if (guardadas) {
        entradasDiario = JSON.parse(guardadas);
      }
      renderizarDiario();
    }

    document.getElementById('diario-guardar').addEventListener('click', () => {
      const texto = document.getElementById('diario-texto').value.trim();
      const inputImagen = document.getElementById('diario-imagen');
      if (!texto) {
        alert("‚ö†Ô∏è Escribe algo en tu cr√≥nica antes de a√±adirla.");
        return;
      }
      const nuevaEntrada = {
        id: Date.now(),
        texto: texto,
        fecha: new Date().toLocaleString('es-ES', { 
          day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        }),
        imagen: null
      };
      if (inputImagen.files && inputImagen.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          nuevaEntrada.imagen = e.target.result;
          entradasDiario.unshift(nuevaEntrada);
          guardarDiario();
          renderizarDiario();
          document.getElementById('diario-texto').value = '';
          inputImagen.value = '';
        };
        reader.readAsDataURL(inputImagen.files[0]);
      } else {
        entradasDiario.unshift(nuevaEntrada);
        guardarDiario();
        renderizarDiario();
        document.getElementById('diario-texto').value = '';
        inputImagen.value = '';
      }
    });

    function guardarDiario() {
      localStorage.setItem('valhalla_diario', JSON.stringify(entradasDiario));
    }

    function renderizarDiario() {
      const contenedor = document.getElementById('diario-entradas');
      contenedor.innerHTML = '';
      if (entradasDiario.length === 0) {
        contenedor.innerHTML = '<p style="color: #AAA; text-align: center;">No hay entradas a√∫n. ¬°Escribe tu primera haza√±a!</p>';
        return;
      }
      entradasDiario.forEach(entrada => {
        const div = document.createElement('div');
        div.className = 'diario-entrada';
        div.innerHTML = `
          <div class="diario-fecha">üìÖ ${entrada.fecha}</div>
          <div class="diario-contenido">${entrada.texto.replace(/\n/g, '<br>')}</div>
          ${entrada.imagen ? `<img src="${entrada.imagen}" class="diario-imagen">` : ''}
          <button class="diario-borrar" onclick="borrarEntrada(${entrada.id})">üóëÔ∏è Eliminar</button>
        `;
        contenedor.appendChild(div);
      });
    }

    function borrarEntrada(id) {
      if (confirm("¬øEliminar esta entrada del diario?")) {
        entradasDiario = entradasDiario.filter(e => e.id !== id);
        guardarDiario();
        renderizarDiario();
      }
    }

    // === EXPORTAR/IMPORTAR ===
    document.getElementById('export-btn').addEventListener('click', () => {
      const data = { player, tasks, unlockedAchievements, diario: entradasDiario, exportedAt: new Date().toISOString() };
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `valhalla-chronicle-progreso-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      alert("‚úÖ Progreso exportado. Guarda este archivo para sincronizar.");
    });

    document.getElementById('import-btn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            player = data.player;
            tasks = data.tasks;
            unlockedAchievements = data.unlockedAchievements || {};
            entradasDiario = data.diario || [];
            saveProgress();
            updateUI();
            renderAll();
            renderizarDiario();
            alert("‚úÖ Progreso importado con √©xito.");
          } catch (err) {
            alert("‚ùå Error al importar: archivo inv√°lido o corrupto.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    // === RESET ===
    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm("¬øReiniciar todo?")) {
        player = { points: 0, level: 1, xp: 0, food: 100, sleep: 100, social: 100, lastFood: Date.now(), lastSleep: Date.now(), lastSocial: Date.now(), continuaSetsCompleted: 0 };
        tasks = { diaria: generateDailyTasks(), continua: generateContinuaTasks(), semanal: generateWeeklyTasks() };
        unlockedAchievements = {};
        entradasDiario = [];
        saveProgress();
        renderAll();
        renderizarDiario();
        updateUI();
      }
    });

    // === INICIALIZACI√ìN ===
    cargarDiario();
    loadProgress();

    // === MANEJO DE PESTA√ëAS (al final) ===
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          tab.classList.add('active');
          const zone = tab.id.replace('tab-', '');
          document.getElementById(`content-${zone}`).classList.add('active');

          if (zone === 'continua') renderTasks('continua');
          if (zone === 'semanal') renderTasks('semanal');
          if (zone === 'logros') renderAchievements();
          if (zone === 'diario') renderizarDiario();
        });
      });
    }

    window.addEventListener('load', setupTabs);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
   
    // === VERIFICAR TAREAS SEMANALES ===
function checkWeeklyTasks() {
  let changed = false;
  tasks.semanal.forEach(task => {
    if (!task.completed && task.condition && task.condition()) {
      task.completed = true;
      player.points += task.points;
      player.xp += task.points;
      changed = true;
    }
  });
  if (changed) {
    saveProgress();
    updateUI();
    renderTasks('semanal');
  }
}
  </script>
</body>
</html>